---
import Layout from "../layouts/main.astro";
import PageHeading from "../components/page-heading.astro";
import { getCollection } from "astro:content";

const allPosts = await getCollection("post");

// 获取 URL 查询参数 ?q=keyword
const url = new URL(Astro.request.url);
const query = url.searchParams.get('q')?.toLowerCase() ?? '';

// 过滤文章
const filteredPosts = allPosts.filter(post =>
  post.data.title.toLowerCase().includes(query) ||
  post.data.description.toLowerCase().includes(query)
);
---

<Layout title="Search Posts">
  <main class="flex flex-col min-h-screen">
    <section class="relative z-20 max-w-2xl mx-auto my-12 px-7 lg:px-0 flex-grow">
      <PageHeading
        title="Search Posts"
        description="Search through my posts by keyword."
      />

      <!-- 搜索表单 -->
      <form method="get" class="my-6">
        <input
          type="text"
          name="q"
          value={query}
          placeholder="Type a keyword and press Enter..."
          class="w-full border rounded px-4 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-400 dark:bg-neutral-900 dark:border-neutral-700 dark:text-neutral-100"
        />
      </form>

      <!-- 搜索结果 -->
      <div class="flex flex-col gap-5 my-8">
        {filteredPosts.length > 0 ? (
          filteredPosts.map(post => (
            <div
              class="relative border border-transparent border-dashed cursor-pointer p-7 group rounded-2xl"
              onclick={`location.href='/post/${post.slug}'`}
            >
              <h2 class="font-bold text-lg mb-2">{post.data.title}</h2>
              <p class="text-sm text-neutral-600 dark:text-neutral-400">{post.data.description}</p>
              <div class="mt-2.5 text-xs font-medium text-neutral-800 dark:text-neutral-300">
                Posted on {post.data.dateFormatted}
              </div>
            </div>
          ))
        ) : (
          <p>No posts found.</p>
        )}
      </div>
    </section>
  </main>
</Layout>
